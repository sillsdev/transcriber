'use strict';

Object.defineProperty(exports, '__esModule', {
  value: true,
});
exports.default = void 0;

var _main = _interopRequireDefault(require('./main'));

var _evented = _interopRequireDefault(require('./evented'));

var _exception = require('./exception');

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : { default: obj };
}

var __decorate =
  (void 0 && (void 0).__decorate) ||
  function (decorators, target, key, desc) {
    var c = arguments.length,
      r =
        c < 3
          ? target
          : desc === null
          ? (desc = Object.getOwnPropertyDescriptor(target, key))
          : desc,
      d;
    if (typeof Reflect === 'object' && typeof Reflect.decorate === 'function')
      r = Reflect.decorate(decorators, target, key, desc);
    else
      for (var i = decorators.length - 1; i >= 0; i--)
        if ((d = decorators[i]))
          r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
  };

const { assert } = _main.default;
/**
 * Logs track a series of unique events that have occurred. Each event is
 * tracked based on its unique id. The log only tracks the ids but currently
 * does not track any details.
 *
 * Logs can automatically be persisted by assigning them a bucket.
 */

let Log = class Log {
  constructor(options = {}) {
    this._name = options.name;
    this._bucket = options.bucket;

    if (this._bucket) {
      assert('Log requires a name if it has a bucket', !!this._name);
    }

    this._reify(options.data);
  }

  get name() {
    return this._name;
  }

  get bucket() {
    return this._bucket;
  }

  get head() {
    return this._data[this._data.length - 1];
  }

  get entries() {
    return this._data;
  }

  get length() {
    return this._data.length;
  }

  append(...ids) {
    return this.reified
      .then(() => {
        Array.prototype.push.apply(this._data, ids);
        return this._persist();
      })
      .then(() => {
        this.emit('append', ids);
      });
  }

  before(id, relativePosition = 0) {
    const index = this._data.indexOf(id);

    if (index === -1) {
      throw new _exception.NotLoggedException(id);
    }

    const position = index + relativePosition;

    if (position < 0 || position >= this._data.length) {
      throw new _exception.OutOfRangeException(position);
    }

    return this._data.slice(0, position);
  }

  after(id, relativePosition = 0) {
    const index = this._data.indexOf(id);

    if (index === -1) {
      throw new _exception.NotLoggedException(id);
    }

    const position = index + 1 + relativePosition;

    if (position < 0 || position > this._data.length) {
      throw new _exception.OutOfRangeException(position);
    }

    return this._data.slice(position);
  }

  truncate(id, relativePosition = 0) {
    let removed;
    return this.reified
      .then(() => {
        const index = this._data.indexOf(id);

        if (index === -1) {
          throw new _exception.NotLoggedException(id);
        }

        const position = index + relativePosition;

        if (position < 0 || position > this._data.length) {
          throw new _exception.OutOfRangeException(position);
        }

        if (position === this._data.length) {
          removed = this._data;
          this._data = [];
        } else {
          removed = this._data.slice(0, position);
          this._data = this._data.slice(position);
        }

        return this._persist();
      })
      .then(() => {
        this.emit('truncate', id, relativePosition, removed);
      });
  }

  rollback(id, relativePosition = 0) {
    let removed;
    return this.reified
      .then(() => {
        const index = this._data.indexOf(id);

        if (index === -1) {
          throw new _exception.NotLoggedException(id);
        }

        const position = index + 1 + relativePosition;

        if (position < 0 || position > this._data.length) {
          throw new _exception.OutOfRangeException(position);
        }

        removed = this._data.slice(position);
        this._data = this._data.slice(0, position);
        return this._persist();
      })
      .then(() => {
        this.emit('rollback', id, relativePosition, removed);
      });
  }

  clear() {
    let clearedData;
    return this.reified
      .then(() => {
        clearedData = this._data;
        this._data = [];
        return this._persist();
      })
      .then(() => this.emit('clear', clearedData));
  }

  contains(id) {
    return this._data?.indexOf(id) > -1;
  }

  _persist() {
    this.emit('change');

    if (this.bucket) {
      return this._bucket.setItem(this.name, this._data);
    } else {
      return Promise.resolve();
    }
  }

  _reify(data) {
    if (!data && this._bucket) {
      this.reified = this._bucket
        .getItem(this._name)
        .then((bucketData) => this._initData(bucketData));
    } else {
      this._initData(data);

      this.reified = Promise.resolve();
    }
  }

  _initData(data) {
    if (data) {
      this._data = data;
    } else {
      this._data = [];
    }
  }
};
Log = __decorate([_evented.default], Log);
var _default = Log;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxvZy5qcyJdLCJuYW1lcyI6WyJfX2RlY29yYXRlIiwiZGVjb3JhdG9ycyIsInRhcmdldCIsImtleSIsImRlc2MiLCJjIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIk9iamVjdCIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImQiLCJSZWZsZWN0IiwiZGVjb3JhdGUiLCJpIiwiZGVmaW5lUHJvcGVydHkiLCJhc3NlcnQiLCJPcmJpdCIsIkxvZyIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsIl9uYW1lIiwibmFtZSIsIl9idWNrZXQiLCJidWNrZXQiLCJfcmVpZnkiLCJkYXRhIiwiaGVhZCIsIl9kYXRhIiwiZW50cmllcyIsImFwcGVuZCIsImlkcyIsInJlaWZpZWQiLCJ0aGVuIiwiQXJyYXkiLCJwcm90b3R5cGUiLCJwdXNoIiwiYXBwbHkiLCJfcGVyc2lzdCIsImVtaXQiLCJiZWZvcmUiLCJpZCIsInJlbGF0aXZlUG9zaXRpb24iLCJpbmRleCIsImluZGV4T2YiLCJOb3RMb2dnZWRFeGNlcHRpb24iLCJwb3NpdGlvbiIsIk91dE9mUmFuZ2VFeGNlcHRpb24iLCJzbGljZSIsImFmdGVyIiwidHJ1bmNhdGUiLCJyZW1vdmVkIiwicm9sbGJhY2siLCJjbGVhciIsImNsZWFyZWREYXRhIiwiY29udGFpbnMiLCJzZXRJdGVtIiwiUHJvbWlzZSIsInJlc29sdmUiLCJnZXRJdGVtIiwiYnVja2V0RGF0YSIsIl9pbml0RGF0YSIsImV2ZW50ZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFRQTs7QUFDQTs7QUFDQTs7OztBQVZBLElBQUlBLFVBQVUsR0FBRyxVQUFRLFNBQUtBLFVBQWIsSUFBMkIsVUFBVUMsVUFBVixFQUFzQkMsTUFBdEIsRUFBOEJDLEdBQTlCLEVBQW1DQyxJQUFuQyxFQUF5QztBQUNuRixNQUFJQyxDQUFDLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBbEI7QUFBQSxNQUNJQyxDQUFDLEdBQUdILENBQUMsR0FBRyxDQUFKLEdBQVFILE1BQVIsR0FBaUJFLElBQUksS0FBSyxJQUFULEdBQWdCQSxJQUFJLEdBQUdLLE1BQU0sQ0FBQ0Msd0JBQVAsQ0FBZ0NSLE1BQWhDLEVBQXdDQyxHQUF4QyxDQUF2QixHQUFzRUMsSUFEL0Y7QUFBQSxNQUVJTyxDQUZKO0FBR0EsTUFBSSxPQUFPQyxPQUFQLEtBQW1CLFFBQW5CLElBQStCLE9BQU9BLE9BQU8sQ0FBQ0MsUUFBZixLQUE0QixVQUEvRCxFQUEyRUwsQ0FBQyxHQUFHSSxPQUFPLENBQUNDLFFBQVIsQ0FBaUJaLFVBQWpCLEVBQTZCQyxNQUE3QixFQUFxQ0MsR0FBckMsRUFBMENDLElBQTFDLENBQUosQ0FBM0UsS0FBb0ksS0FBSyxJQUFJVSxDQUFDLEdBQUdiLFVBQVUsQ0FBQ00sTUFBWCxHQUFvQixDQUFqQyxFQUFvQ08sQ0FBQyxJQUFJLENBQXpDLEVBQTRDQSxDQUFDLEVBQTdDLEVBQWlELElBQUlILENBQUMsR0FBR1YsVUFBVSxDQUFDYSxDQUFELENBQWxCLEVBQXVCTixDQUFDLEdBQUcsQ0FBQ0gsQ0FBQyxHQUFHLENBQUosR0FBUU0sQ0FBQyxDQUFDSCxDQUFELENBQVQsR0FBZUgsQ0FBQyxHQUFHLENBQUosR0FBUU0sQ0FBQyxDQUFDVCxNQUFELEVBQVNDLEdBQVQsRUFBY0ssQ0FBZCxDQUFULEdBQTRCRyxDQUFDLENBQUNULE1BQUQsRUFBU0MsR0FBVCxDQUE3QyxLQUErREssQ0FBbkU7QUFDNU0sU0FBT0gsQ0FBQyxHQUFHLENBQUosSUFBU0csQ0FBVCxJQUFjQyxNQUFNLENBQUNNLGNBQVAsQ0FBc0JiLE1BQXRCLEVBQThCQyxHQUE5QixFQUFtQ0ssQ0FBbkMsQ0FBZCxFQUFxREEsQ0FBNUQ7QUFDRCxDQU5EOztBQVdBLE1BQU07QUFDSlEsRUFBQUE7QUFESSxJQUVGQyxhQUZKO0FBR0E7Ozs7Ozs7O0FBUUEsSUFBSUMsR0FBRyxHQUFHLE1BQU1BLEdBQU4sQ0FBVTtBQUNsQkMsRUFBQUEsV0FBVyxDQUFDQyxPQUFPLEdBQUcsRUFBWCxFQUFlO0FBQ3hCLFNBQUtDLEtBQUwsR0FBYUQsT0FBTyxDQUFDRSxJQUFyQjtBQUNBLFNBQUtDLE9BQUwsR0FBZUgsT0FBTyxDQUFDSSxNQUF2Qjs7QUFFQSxRQUFJLEtBQUtELE9BQVQsRUFBa0I7QUFDaEJQLE1BQUFBLE1BQU0sQ0FBQyx3Q0FBRCxFQUEyQyxDQUFDLENBQUMsS0FBS0ssS0FBbEQsQ0FBTjtBQUNEOztBQUVELFNBQUtJLE1BQUwsQ0FBWUwsT0FBTyxDQUFDTSxJQUFwQjtBQUNEOztBQUVELE1BQUlKLElBQUosR0FBVztBQUNULFdBQU8sS0FBS0QsS0FBWjtBQUNEOztBQUVELE1BQUlHLE1BQUosR0FBYTtBQUNYLFdBQU8sS0FBS0QsT0FBWjtBQUNEOztBQUVELE1BQUlJLElBQUosR0FBVztBQUNULFdBQU8sS0FBS0MsS0FBTCxDQUFXLEtBQUtBLEtBQUwsQ0FBV3JCLE1BQVgsR0FBb0IsQ0FBL0IsQ0FBUDtBQUNEOztBQUVELE1BQUlzQixPQUFKLEdBQWM7QUFDWixXQUFPLEtBQUtELEtBQVo7QUFDRDs7QUFFRCxNQUFJckIsTUFBSixHQUFhO0FBQ1gsV0FBTyxLQUFLcUIsS0FBTCxDQUFXckIsTUFBbEI7QUFDRDs7QUFFRHVCLEVBQUFBLE1BQU0sQ0FBQyxHQUFHQyxHQUFKLEVBQVM7QUFDYixXQUFPLEtBQUtDLE9BQUwsQ0FBYUMsSUFBYixDQUFrQixNQUFNO0FBQzdCQyxNQUFBQSxLQUFLLENBQUNDLFNBQU4sQ0FBZ0JDLElBQWhCLENBQXFCQyxLQUFyQixDQUEyQixLQUFLVCxLQUFoQyxFQUF1Q0csR0FBdkM7QUFDQSxhQUFPLEtBQUtPLFFBQUwsRUFBUDtBQUNELEtBSE0sRUFHSkwsSUFISSxDQUdDLE1BQU07QUFDWixXQUFLTSxJQUFMLENBQVUsUUFBVixFQUFvQlIsR0FBcEI7QUFDRCxLQUxNLENBQVA7QUFNRDs7QUFFRFMsRUFBQUEsTUFBTSxDQUFDQyxFQUFELEVBQUtDLGdCQUFnQixHQUFHLENBQXhCLEVBQTJCO0FBQy9CLFVBQU1DLEtBQUssR0FBRyxLQUFLZixLQUFMLENBQVdnQixPQUFYLENBQW1CSCxFQUFuQixDQUFkOztBQUVBLFFBQUlFLEtBQUssS0FBSyxDQUFDLENBQWYsRUFBa0I7QUFDaEIsWUFBTSxJQUFJRSw2QkFBSixDQUF1QkosRUFBdkIsQ0FBTjtBQUNEOztBQUVELFVBQU1LLFFBQVEsR0FBR0gsS0FBSyxHQUFHRCxnQkFBekI7O0FBRUEsUUFBSUksUUFBUSxHQUFHLENBQVgsSUFBZ0JBLFFBQVEsSUFBSSxLQUFLbEIsS0FBTCxDQUFXckIsTUFBM0MsRUFBbUQ7QUFDakQsWUFBTSxJQUFJd0MsOEJBQUosQ0FBd0JELFFBQXhCLENBQU47QUFDRDs7QUFFRCxXQUFPLEtBQUtsQixLQUFMLENBQVdvQixLQUFYLENBQWlCLENBQWpCLEVBQW9CRixRQUFwQixDQUFQO0FBQ0Q7O0FBRURHLEVBQUFBLEtBQUssQ0FBQ1IsRUFBRCxFQUFLQyxnQkFBZ0IsR0FBRyxDQUF4QixFQUEyQjtBQUM5QixVQUFNQyxLQUFLLEdBQUcsS0FBS2YsS0FBTCxDQUFXZ0IsT0FBWCxDQUFtQkgsRUFBbkIsQ0FBZDs7QUFFQSxRQUFJRSxLQUFLLEtBQUssQ0FBQyxDQUFmLEVBQWtCO0FBQ2hCLFlBQU0sSUFBSUUsNkJBQUosQ0FBdUJKLEVBQXZCLENBQU47QUFDRDs7QUFFRCxVQUFNSyxRQUFRLEdBQUdILEtBQUssR0FBRyxDQUFSLEdBQVlELGdCQUE3Qjs7QUFFQSxRQUFJSSxRQUFRLEdBQUcsQ0FBWCxJQUFnQkEsUUFBUSxHQUFHLEtBQUtsQixLQUFMLENBQVdyQixNQUExQyxFQUFrRDtBQUNoRCxZQUFNLElBQUl3Qyw4QkFBSixDQUF3QkQsUUFBeEIsQ0FBTjtBQUNEOztBQUVELFdBQU8sS0FBS2xCLEtBQUwsQ0FBV29CLEtBQVgsQ0FBaUJGLFFBQWpCLENBQVA7QUFDRDs7QUFFREksRUFBQUEsUUFBUSxDQUFDVCxFQUFELEVBQUtDLGdCQUFnQixHQUFHLENBQXhCLEVBQTJCO0FBQ2pDLFFBQUlTLE9BQUo7QUFDQSxXQUFPLEtBQUtuQixPQUFMLENBQWFDLElBQWIsQ0FBa0IsTUFBTTtBQUM3QixZQUFNVSxLQUFLLEdBQUcsS0FBS2YsS0FBTCxDQUFXZ0IsT0FBWCxDQUFtQkgsRUFBbkIsQ0FBZDs7QUFFQSxVQUFJRSxLQUFLLEtBQUssQ0FBQyxDQUFmLEVBQWtCO0FBQ2hCLGNBQU0sSUFBSUUsNkJBQUosQ0FBdUJKLEVBQXZCLENBQU47QUFDRDs7QUFFRCxZQUFNSyxRQUFRLEdBQUdILEtBQUssR0FBR0QsZ0JBQXpCOztBQUVBLFVBQUlJLFFBQVEsR0FBRyxDQUFYLElBQWdCQSxRQUFRLEdBQUcsS0FBS2xCLEtBQUwsQ0FBV3JCLE1BQTFDLEVBQWtEO0FBQ2hELGNBQU0sSUFBSXdDLDhCQUFKLENBQXdCRCxRQUF4QixDQUFOO0FBQ0Q7O0FBRUQsVUFBSUEsUUFBUSxLQUFLLEtBQUtsQixLQUFMLENBQVdyQixNQUE1QixFQUFvQztBQUNsQzRDLFFBQUFBLE9BQU8sR0FBRyxLQUFLdkIsS0FBZjtBQUNBLGFBQUtBLEtBQUwsR0FBYSxFQUFiO0FBQ0QsT0FIRCxNQUdPO0FBQ0x1QixRQUFBQSxPQUFPLEdBQUcsS0FBS3ZCLEtBQUwsQ0FBV29CLEtBQVgsQ0FBaUIsQ0FBakIsRUFBb0JGLFFBQXBCLENBQVY7QUFDQSxhQUFLbEIsS0FBTCxHQUFhLEtBQUtBLEtBQUwsQ0FBV29CLEtBQVgsQ0FBaUJGLFFBQWpCLENBQWI7QUFDRDs7QUFFRCxhQUFPLEtBQUtSLFFBQUwsRUFBUDtBQUNELEtBdEJNLEVBc0JKTCxJQXRCSSxDQXNCQyxNQUFNO0FBQ1osV0FBS00sSUFBTCxDQUFVLFVBQVYsRUFBc0JFLEVBQXRCLEVBQTBCQyxnQkFBMUIsRUFBNENTLE9BQTVDO0FBQ0QsS0F4Qk0sQ0FBUDtBQXlCRDs7QUFFREMsRUFBQUEsUUFBUSxDQUFDWCxFQUFELEVBQUtDLGdCQUFnQixHQUFHLENBQXhCLEVBQTJCO0FBQ2pDLFFBQUlTLE9BQUo7QUFDQSxXQUFPLEtBQUtuQixPQUFMLENBQWFDLElBQWIsQ0FBa0IsTUFBTTtBQUM3QixZQUFNVSxLQUFLLEdBQUcsS0FBS2YsS0FBTCxDQUFXZ0IsT0FBWCxDQUFtQkgsRUFBbkIsQ0FBZDs7QUFFQSxVQUFJRSxLQUFLLEtBQUssQ0FBQyxDQUFmLEVBQWtCO0FBQ2hCLGNBQU0sSUFBSUUsNkJBQUosQ0FBdUJKLEVBQXZCLENBQU47QUFDRDs7QUFFRCxZQUFNSyxRQUFRLEdBQUdILEtBQUssR0FBRyxDQUFSLEdBQVlELGdCQUE3Qjs7QUFFQSxVQUFJSSxRQUFRLEdBQUcsQ0FBWCxJQUFnQkEsUUFBUSxHQUFHLEtBQUtsQixLQUFMLENBQVdyQixNQUExQyxFQUFrRDtBQUNoRCxjQUFNLElBQUl3Qyw4QkFBSixDQUF3QkQsUUFBeEIsQ0FBTjtBQUNEOztBQUVESyxNQUFBQSxPQUFPLEdBQUcsS0FBS3ZCLEtBQUwsQ0FBV29CLEtBQVgsQ0FBaUJGLFFBQWpCLENBQVY7QUFDQSxXQUFLbEIsS0FBTCxHQUFhLEtBQUtBLEtBQUwsQ0FBV29CLEtBQVgsQ0FBaUIsQ0FBakIsRUFBb0JGLFFBQXBCLENBQWI7QUFDQSxhQUFPLEtBQUtSLFFBQUwsRUFBUDtBQUNELEtBaEJNLEVBZ0JKTCxJQWhCSSxDQWdCQyxNQUFNO0FBQ1osV0FBS00sSUFBTCxDQUFVLFVBQVYsRUFBc0JFLEVBQXRCLEVBQTBCQyxnQkFBMUIsRUFBNENTLE9BQTVDO0FBQ0QsS0FsQk0sQ0FBUDtBQW1CRDs7QUFFREUsRUFBQUEsS0FBSyxHQUFHO0FBQ04sUUFBSUMsV0FBSjtBQUNBLFdBQU8sS0FBS3RCLE9BQUwsQ0FBYUMsSUFBYixDQUFrQixNQUFNO0FBQzdCcUIsTUFBQUEsV0FBVyxHQUFHLEtBQUsxQixLQUFuQjtBQUNBLFdBQUtBLEtBQUwsR0FBYSxFQUFiO0FBQ0EsYUFBTyxLQUFLVSxRQUFMLEVBQVA7QUFDRCxLQUpNLEVBSUpMLElBSkksQ0FJQyxNQUFNLEtBQUtNLElBQUwsQ0FBVSxPQUFWLEVBQW1CZSxXQUFuQixDQUpQLENBQVA7QUFLRDs7QUFFREMsRUFBQUEsUUFBUSxDQUFDZCxFQUFELEVBQUs7QUFDWCxXQUFPLEtBQUtiLEtBQUwsQ0FBV2dCLE9BQVgsQ0FBbUJILEVBQW5CLElBQXlCLENBQUMsQ0FBakM7QUFDRDs7QUFFREgsRUFBQUEsUUFBUSxHQUFHO0FBQ1QsU0FBS0MsSUFBTCxDQUFVLFFBQVY7O0FBRUEsUUFBSSxLQUFLZixNQUFULEVBQWlCO0FBQ2YsYUFBTyxLQUFLRCxPQUFMLENBQWFpQyxPQUFiLENBQXFCLEtBQUtsQyxJQUExQixFQUFnQyxLQUFLTSxLQUFyQyxDQUFQO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsYUFBTzZCLE9BQU8sQ0FBQ0MsT0FBUixFQUFQO0FBQ0Q7QUFDRjs7QUFFRGpDLEVBQUFBLE1BQU0sQ0FBQ0MsSUFBRCxFQUFPO0FBQ1gsUUFBSSxDQUFDQSxJQUFELElBQVMsS0FBS0gsT0FBbEIsRUFBMkI7QUFDekIsV0FBS1MsT0FBTCxHQUFlLEtBQUtULE9BQUwsQ0FBYW9DLE9BQWIsQ0FBcUIsS0FBS3RDLEtBQTFCLEVBQWlDWSxJQUFqQyxDQUFzQzJCLFVBQVUsSUFBSSxLQUFLQyxTQUFMLENBQWVELFVBQWYsQ0FBcEQsQ0FBZjtBQUNELEtBRkQsTUFFTztBQUNMLFdBQUtDLFNBQUwsQ0FBZW5DLElBQWY7O0FBRUEsV0FBS00sT0FBTCxHQUFleUIsT0FBTyxDQUFDQyxPQUFSLEVBQWY7QUFDRDtBQUNGOztBQUVERyxFQUFBQSxTQUFTLENBQUNuQyxJQUFELEVBQU87QUFDZCxRQUFJQSxJQUFKLEVBQVU7QUFDUixXQUFLRSxLQUFMLEdBQWFGLElBQWI7QUFDRCxLQUZELE1BRU87QUFDTCxXQUFLRSxLQUFMLEdBQWEsRUFBYjtBQUNEO0FBQ0Y7O0FBcEtpQixDQUFwQjtBQXVLQVYsR0FBRyxHQUFHbEIsVUFBVSxDQUFDLENBQUM4RCxnQkFBRCxDQUFELEVBQVk1QyxHQUFaLENBQWhCO2VBQ2VBLEciLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgX19kZWNvcmF0ZSA9IHRoaXMgJiYgdGhpcy5fX2RlY29yYXRlIHx8IGZ1bmN0aW9uIChkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYykge1xuICB2YXIgYyA9IGFyZ3VtZW50cy5sZW5ndGgsXG4gICAgICByID0gYyA8IDMgPyB0YXJnZXQgOiBkZXNjID09PSBudWxsID8gZGVzYyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IodGFyZ2V0LCBrZXkpIDogZGVzYyxcbiAgICAgIGQ7XG4gIGlmICh0eXBlb2YgUmVmbGVjdCA9PT0gXCJvYmplY3RcIiAmJiB0eXBlb2YgUmVmbGVjdC5kZWNvcmF0ZSA9PT0gXCJmdW5jdGlvblwiKSByID0gUmVmbGVjdC5kZWNvcmF0ZShkZWNvcmF0b3JzLCB0YXJnZXQsIGtleSwgZGVzYyk7ZWxzZSBmb3IgKHZhciBpID0gZGVjb3JhdG9ycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgaWYgKGQgPSBkZWNvcmF0b3JzW2ldKSByID0gKGMgPCAzID8gZChyKSA6IGMgPiAzID8gZCh0YXJnZXQsIGtleSwgcikgOiBkKHRhcmdldCwga2V5KSkgfHwgcjtcbiAgcmV0dXJuIGMgPiAzICYmIHIgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCByKSwgcjtcbn07XG5cbmltcG9ydCBPcmJpdCBmcm9tICcuL21haW4nO1xuaW1wb3J0IGV2ZW50ZWQgZnJvbSAnLi9ldmVudGVkJztcbmltcG9ydCB7IE5vdExvZ2dlZEV4Y2VwdGlvbiwgT3V0T2ZSYW5nZUV4Y2VwdGlvbiB9IGZyb20gJy4vZXhjZXB0aW9uJztcbmNvbnN0IHtcbiAgYXNzZXJ0XG59ID0gT3JiaXQ7XG4vKipcbiAqIExvZ3MgdHJhY2sgYSBzZXJpZXMgb2YgdW5pcXVlIGV2ZW50cyB0aGF0IGhhdmUgb2NjdXJyZWQuIEVhY2ggZXZlbnQgaXNcbiAqIHRyYWNrZWQgYmFzZWQgb24gaXRzIHVuaXF1ZSBpZC4gVGhlIGxvZyBvbmx5IHRyYWNrcyB0aGUgaWRzIGJ1dCBjdXJyZW50bHlcbiAqIGRvZXMgbm90IHRyYWNrIGFueSBkZXRhaWxzLlxuICpcbiAqIExvZ3MgY2FuIGF1dG9tYXRpY2FsbHkgYmUgcGVyc2lzdGVkIGJ5IGFzc2lnbmluZyB0aGVtIGEgYnVja2V0LlxuICovXG5cbmxldCBMb2cgPSBjbGFzcyBMb2cge1xuICBjb25zdHJ1Y3RvcihvcHRpb25zID0ge30pIHtcbiAgICB0aGlzLl9uYW1lID0gb3B0aW9ucy5uYW1lO1xuICAgIHRoaXMuX2J1Y2tldCA9IG9wdGlvbnMuYnVja2V0O1xuXG4gICAgaWYgKHRoaXMuX2J1Y2tldCkge1xuICAgICAgYXNzZXJ0KCdMb2cgcmVxdWlyZXMgYSBuYW1lIGlmIGl0IGhhcyBhIGJ1Y2tldCcsICEhdGhpcy5fbmFtZSk7XG4gICAgfVxuXG4gICAgdGhpcy5fcmVpZnkob3B0aW9ucy5kYXRhKTtcbiAgfVxuXG4gIGdldCBuYW1lKCkge1xuICAgIHJldHVybiB0aGlzLl9uYW1lO1xuICB9XG5cbiAgZ2V0IGJ1Y2tldCgpIHtcbiAgICByZXR1cm4gdGhpcy5fYnVja2V0O1xuICB9XG5cbiAgZ2V0IGhlYWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2RhdGFbdGhpcy5fZGF0YS5sZW5ndGggLSAxXTtcbiAgfVxuXG4gIGdldCBlbnRyaWVzKCkge1xuICAgIHJldHVybiB0aGlzLl9kYXRhO1xuICB9XG5cbiAgZ2V0IGxlbmd0aCgpIHtcbiAgICByZXR1cm4gdGhpcy5fZGF0YS5sZW5ndGg7XG4gIH1cblxuICBhcHBlbmQoLi4uaWRzKSB7XG4gICAgcmV0dXJuIHRoaXMucmVpZmllZC50aGVuKCgpID0+IHtcbiAgICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KHRoaXMuX2RhdGEsIGlkcyk7XG4gICAgICByZXR1cm4gdGhpcy5fcGVyc2lzdCgpO1xuICAgIH0pLnRoZW4oKCkgPT4ge1xuICAgICAgdGhpcy5lbWl0KCdhcHBlbmQnLCBpZHMpO1xuICAgIH0pO1xuICB9XG5cbiAgYmVmb3JlKGlkLCByZWxhdGl2ZVBvc2l0aW9uID0gMCkge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5fZGF0YS5pbmRleE9mKGlkKTtcblxuICAgIGlmIChpbmRleCA9PT0gLTEpIHtcbiAgICAgIHRocm93IG5ldyBOb3RMb2dnZWRFeGNlcHRpb24oaWQpO1xuICAgIH1cblxuICAgIGNvbnN0IHBvc2l0aW9uID0gaW5kZXggKyByZWxhdGl2ZVBvc2l0aW9uO1xuXG4gICAgaWYgKHBvc2l0aW9uIDwgMCB8fCBwb3NpdGlvbiA+PSB0aGlzLl9kYXRhLmxlbmd0aCkge1xuICAgICAgdGhyb3cgbmV3IE91dE9mUmFuZ2VFeGNlcHRpb24ocG9zaXRpb24pO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLl9kYXRhLnNsaWNlKDAsIHBvc2l0aW9uKTtcbiAgfVxuXG4gIGFmdGVyKGlkLCByZWxhdGl2ZVBvc2l0aW9uID0gMCkge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5fZGF0YS5pbmRleE9mKGlkKTtcblxuICAgIGlmIChpbmRleCA9PT0gLTEpIHtcbiAgICAgIHRocm93IG5ldyBOb3RMb2dnZWRFeGNlcHRpb24oaWQpO1xuICAgIH1cblxuICAgIGNvbnN0IHBvc2l0aW9uID0gaW5kZXggKyAxICsgcmVsYXRpdmVQb3NpdGlvbjtcblxuICAgIGlmIChwb3NpdGlvbiA8IDAgfHwgcG9zaXRpb24gPiB0aGlzLl9kYXRhLmxlbmd0aCkge1xuICAgICAgdGhyb3cgbmV3IE91dE9mUmFuZ2VFeGNlcHRpb24ocG9zaXRpb24pO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLl9kYXRhLnNsaWNlKHBvc2l0aW9uKTtcbiAgfVxuXG4gIHRydW5jYXRlKGlkLCByZWxhdGl2ZVBvc2l0aW9uID0gMCkge1xuICAgIGxldCByZW1vdmVkO1xuICAgIHJldHVybiB0aGlzLnJlaWZpZWQudGhlbigoKSA9PiB7XG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuX2RhdGEuaW5kZXhPZihpZCk7XG5cbiAgICAgIGlmIChpbmRleCA9PT0gLTEpIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vdExvZ2dlZEV4Y2VwdGlvbihpZCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHBvc2l0aW9uID0gaW5kZXggKyByZWxhdGl2ZVBvc2l0aW9uO1xuXG4gICAgICBpZiAocG9zaXRpb24gPCAwIHx8IHBvc2l0aW9uID4gdGhpcy5fZGF0YS5sZW5ndGgpIHtcbiAgICAgICAgdGhyb3cgbmV3IE91dE9mUmFuZ2VFeGNlcHRpb24ocG9zaXRpb24pO1xuICAgICAgfVxuXG4gICAgICBpZiAocG9zaXRpb24gPT09IHRoaXMuX2RhdGEubGVuZ3RoKSB7XG4gICAgICAgIHJlbW92ZWQgPSB0aGlzLl9kYXRhO1xuICAgICAgICB0aGlzLl9kYXRhID0gW107XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZW1vdmVkID0gdGhpcy5fZGF0YS5zbGljZSgwLCBwb3NpdGlvbik7XG4gICAgICAgIHRoaXMuX2RhdGEgPSB0aGlzLl9kYXRhLnNsaWNlKHBvc2l0aW9uKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMuX3BlcnNpc3QoKTtcbiAgICB9KS50aGVuKCgpID0+IHtcbiAgICAgIHRoaXMuZW1pdCgndHJ1bmNhdGUnLCBpZCwgcmVsYXRpdmVQb3NpdGlvbiwgcmVtb3ZlZCk7XG4gICAgfSk7XG4gIH1cblxuICByb2xsYmFjayhpZCwgcmVsYXRpdmVQb3NpdGlvbiA9IDApIHtcbiAgICBsZXQgcmVtb3ZlZDtcbiAgICByZXR1cm4gdGhpcy5yZWlmaWVkLnRoZW4oKCkgPT4ge1xuICAgICAgY29uc3QgaW5kZXggPSB0aGlzLl9kYXRhLmluZGV4T2YoaWQpO1xuXG4gICAgICBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICAgIHRocm93IG5ldyBOb3RMb2dnZWRFeGNlcHRpb24oaWQpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBwb3NpdGlvbiA9IGluZGV4ICsgMSArIHJlbGF0aXZlUG9zaXRpb247XG5cbiAgICAgIGlmIChwb3NpdGlvbiA8IDAgfHwgcG9zaXRpb24gPiB0aGlzLl9kYXRhLmxlbmd0aCkge1xuICAgICAgICB0aHJvdyBuZXcgT3V0T2ZSYW5nZUV4Y2VwdGlvbihwb3NpdGlvbik7XG4gICAgICB9XG5cbiAgICAgIHJlbW92ZWQgPSB0aGlzLl9kYXRhLnNsaWNlKHBvc2l0aW9uKTtcbiAgICAgIHRoaXMuX2RhdGEgPSB0aGlzLl9kYXRhLnNsaWNlKDAsIHBvc2l0aW9uKTtcbiAgICAgIHJldHVybiB0aGlzLl9wZXJzaXN0KCk7XG4gICAgfSkudGhlbigoKSA9PiB7XG4gICAgICB0aGlzLmVtaXQoJ3JvbGxiYWNrJywgaWQsIHJlbGF0aXZlUG9zaXRpb24sIHJlbW92ZWQpO1xuICAgIH0pO1xuICB9XG5cbiAgY2xlYXIoKSB7XG4gICAgbGV0IGNsZWFyZWREYXRhO1xuICAgIHJldHVybiB0aGlzLnJlaWZpZWQudGhlbigoKSA9PiB7XG4gICAgICBjbGVhcmVkRGF0YSA9IHRoaXMuX2RhdGE7XG4gICAgICB0aGlzLl9kYXRhID0gW107XG4gICAgICByZXR1cm4gdGhpcy5fcGVyc2lzdCgpO1xuICAgIH0pLnRoZW4oKCkgPT4gdGhpcy5lbWl0KCdjbGVhcicsIGNsZWFyZWREYXRhKSk7XG4gIH1cblxuICBjb250YWlucyhpZCkge1xuICAgIHJldHVybiB0aGlzLl9kYXRhLmluZGV4T2YoaWQpID4gLTE7XG4gIH1cblxuICBfcGVyc2lzdCgpIHtcbiAgICB0aGlzLmVtaXQoJ2NoYW5nZScpO1xuXG4gICAgaWYgKHRoaXMuYnVja2V0KSB7XG4gICAgICByZXR1cm4gdGhpcy5fYnVja2V0LnNldEl0ZW0odGhpcy5uYW1lLCB0aGlzLl9kYXRhKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH1cbiAgfVxuXG4gIF9yZWlmeShkYXRhKSB7XG4gICAgaWYgKCFkYXRhICYmIHRoaXMuX2J1Y2tldCkge1xuICAgICAgdGhpcy5yZWlmaWVkID0gdGhpcy5fYnVja2V0LmdldEl0ZW0odGhpcy5fbmFtZSkudGhlbihidWNrZXREYXRhID0+IHRoaXMuX2luaXREYXRhKGJ1Y2tldERhdGEpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5faW5pdERhdGEoZGF0YSk7XG5cbiAgICAgIHRoaXMucmVpZmllZCA9IFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH1cbiAgfVxuXG4gIF9pbml0RGF0YShkYXRhKSB7XG4gICAgaWYgKGRhdGEpIHtcbiAgICAgIHRoaXMuX2RhdGEgPSBkYXRhO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9kYXRhID0gW107XG4gICAgfVxuICB9XG5cbn07XG5Mb2cgPSBfX2RlY29yYXRlKFtldmVudGVkXSwgTG9nKTtcbmV4cG9ydCBkZWZhdWx0IExvZzsiXX0=
